rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is super admin (checks Firestore user role)
    function isSuperAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPER_ADMIN';
    }
    
    // Helper: user owns the shop (shop.ownerId matches current user)
    function isShopOwner(shopId) {
      return isAuthenticated() && shopId is string &&
             get(/databases/$(database)/documents/shops/$(shopId)).data.ownerId == request.auth.uid;
    }
    
    // Helper: user has access to shop (owner OR staff assigned to that shop)
    function hasShopAccess(shopId) {
      let shopData = get(/databases/$(database)/documents/shops/$(shopId)).data;
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return isAuthenticated() && shopId is string && (
        (shopData != null && shopData.ownerId == request.auth.uid) ||
        (userData != null && userData.shopId == shopId)
      );
    }
    
    // Users collection - users can read/write own data; can read users in same shop (team members)
    // Super admins can read/write all user data
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isSuperAdmin() ||
        (resource.data.shopId != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.shopId == resource.data.shopId)
      );
      allow write: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());
    }
    
    // Shops collection - shop owners can manage their shops
    // Allow public get for invoice letterhead (name, contact)
    match /shops/{shopId} {
      allow get: if true;
      allow list: if isSuperAdmin();
      allow write: if hasShopAccess(shopId) || isSuperAdmin();
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }
    
    // Customers collection - shop owners can manage their customers
    // Allow public get for invoice display (customer is shared with via invoice link)
    match /customers/{customerId} {
      allow get: if true;
      allow list, write: if hasShopAccess(resource.data.shopId) || isSuperAdmin();
      allow create: if isAuthenticated() && hasShopAccess(request.resource.data.shopId);
    }
    
    // Orders collection - shop owners can manage their orders
    // Allow public get for shareable invoice links (order ID acts as token)
    match /orders/{orderId} {
      allow get: if true;
      allow list, write: if hasShopAccess(resource.data.shopId) || isSuperAdmin();
      allow create: if isAuthenticated() && hasShopAccess(request.resource.data.shopId);
    }
    
    // Measurements collection - shop owners can manage their measurements
    match /measurements/{measurementId} {
      allow read, write: if hasShopAccess(resource.data.shopId) || isSuperAdmin();
      allow create: if isAuthenticated() && hasShopAccess(request.resource.data.shopId);
    }
    
    // Payments collection - shop owners can manage their payments
    match /payments/{paymentId} {
      allow read, write: if hasShopAccess(resource.data.shopId) || isSuperAdmin();
      allow create: if isAuthenticated() && hasShopAccess(request.resource.data.shopId);
    }
    
    // Debts collection - shop owners can manage their debts
    match /debts/{debtId} {
      allow read, write: if hasShopAccess(resource.data.shopId) || isSuperAdmin();
      allow create: if isAuthenticated() && hasShopAccess(request.resource.data.shopId);
    }
    
    // Expenses collection - shop owners can manage their expenses
    match /expenses/{expenseId} {
      allow read, write: if hasShopAccess(resource.data.shopId) || isSuperAdmin();
      allow create: if isAuthenticated() && hasShopAccess(request.resource.data.shopId);
    }
    
    // Subscriptions collection - shop owners can read their subscriptions, super admins can manage all
    match /subscriptions/{subscriptionId} {
      allow read: if hasShopAccess(resource.data.shopId) || isSuperAdmin();
      allow write: if isSuperAdmin();
      allow create: if isSuperAdmin();
    }
    
    // Billing Plans collection - authenticated users can read, super admins can manage
    match /plans/{planId} {
      allow read: if isAuthenticated();
      allow write, create, delete: if isSuperAdmin();
    }
    
    // Team Invitations collection - shop owners can manage their invitations
    match /teamInvitations/{invitationId} {
      allow read, write: if hasShopAccess(resource.data.shopId) || isSuperAdmin();
      allow create: if isAuthenticated() && hasShopAccess(request.resource.data.shopId);
    }
    
    // Notification Settings collection - users can manage their own settings
    match /notificationSettings/{settingsId} {
      allow read, write: if isAuthenticated() && request.auth.uid == resource.data.userId;
      allow create: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
